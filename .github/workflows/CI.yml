name: Sync GitHub to cPanel (FTP – Delta Deploy)

on:
  push:
    branches:
      - main   # only this branch deploys

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # REQUIRED for git diff

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy only changed files
        env:
          HOST: ${{ secrets.CPANEL_FTP_HOST }}
          USER: ${{ secrets.CPANEL_FTP_USER }}
          PASS: ${{ secrets.CPANEL_FTP_PASS }}
          REMOTE_DIR: ${{ secrets.CPANEL_REMOTE_DIR }}
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "Deploying changes: $BEFORE → $AFTER"

          # Handle first push / force push
          if ! git cat-file -e "$BEFORE^{commit}" 2>/dev/null; then
            BEFORE="$(git rev-parse "$AFTER^")"
            echo "Fallback BEFORE=$BEFORE"
          fi

          FTP_CMDS=$(mktemp)

          # Use git's native rename detection
          git diff --name-status -M "$BEFORE" "$AFTER" | while read -r status src dst; do
            case "$status" in
              R*)
                echo "rm -rf \"$src\"" >> "$FTP_CMDS"
                echo "put \"$dst\"" >> "$FTP_CMDS"
                ;;
              A|M)
                echo "put \"$src\"" >> "$FTP_CMDS"
                ;;
              D)
                echo "rm -rf \"$src\"" >> "$FTP_CMDS"
                ;;
            esac
          done

          echo "FTP actions:"
          cat "$FTP_CMDS" || true

          if [ ! -s "$FTP_CMDS" ]; then
            echo "No changes to deploy."
            exit 0
          fi

          lftp -u "$USER","$PASS" ftp://$HOST <<EOF
          set ftp:ssl-allow yes
          set ftp:ssl-force no
          set ftp:ssl-protect-data no
          set ssl:verify-certificate no
          set ftp:passive-mode yes
          set net:max-retries 2
          set net:timeout 20
          set cmd:fail-exit yes
          set cmd:verbose yes

          cd "$REMOTE_DIR"

          $(cat "$FTP_CMDS")

          quit
          EOF
